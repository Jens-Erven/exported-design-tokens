name: Validate Tokens

on:
  push:
    branches: [main, master]
    paths:
      - "brands/**/*-tokens.json"
  pull_request:
    branches: [main, master]
    paths:
      - "brands/**/*-tokens.json"

jobs:
  detect-brands:
    runs-on: ubuntu-latest
    outputs:
      brands: ${{ steps.detect.outputs.brands }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 2

      - name: Detect changed brand files
        id: detect
        run: |
          # Get changed files
          if [ "${{ github.event_name }}" == "pull_request" ]; then
            CHANGED_FILES=$(git diff --name-only --diff-filter=ACMR origin/${{ github.base_ref }}...HEAD | grep -E 'brands/.*-tokens\.json$' || true)
          else
            CHANGED_FILES=$(git diff --name-only --diff-filter=ACMR HEAD~1 HEAD | grep -E 'brands/.*-tokens\.json$' || true)
          fi

          # Extract brand names from filenames (e.g., brands/brio-tokens.json -> brio)
          BRANDS_JSON="["
          FIRST=true
          for file in $CHANGED_FILES; do
            if [ -n "$file" ]; then
              BRAND=$(basename "$file" | sed 's/-tokens\.json$//')
              if [ "$FIRST" = true ]; then
                BRANDS_JSON="${BRANDS_JSON}\"${BRAND}\""
                FIRST=false
              else
                BRANDS_JSON="${BRANDS_JSON},\"${BRAND}\""
              fi
            fi
          done

          # If no changed files detected, check all brand files in the repo
          if [ "$BRANDS_JSON" = "[" ]; then
            for file in brands/*-tokens.json; do
              if [ -f "$file" ]; then
                BRAND=$(basename "$file" | sed 's/-tokens\.json$//')
                if [ "$FIRST" = true ]; then
                  BRANDS_JSON="${BRANDS_JSON}\"${BRAND}\""
                  FIRST=false
                else
                  BRANDS_JSON="${BRANDS_JSON},\"${BRAND}\""
                fi
              fi
            done
          fi

          BRANDS_JSON="${BRANDS_JSON}]"
          echo "brands=$BRANDS_JSON" >> $GITHUB_OUTPUT
          echo "Detected brands: $BRANDS_JSON"

  validate:
    needs: detect-brands
    runs-on: ubuntu-latest
    if: needs.detect-brands.outputs.brands != '[]'
    strategy:
      matrix:
        brand: ${{ fromJson(needs.detect-brands.outputs.brands) }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "18"

      - name: Validate JSON syntax
        run: |
          BRAND_FILE="brands/${{ matrix.brand }}-tokens.json"
          if [ ! -f "$BRAND_FILE" ]; then
            echo "❌ Error: Brand file $BRAND_FILE not found"
            exit 1
          fi
          node -e "JSON.parse(require('fs').readFileSync('$BRAND_FILE', 'utf8')); console.log('✅ JSON syntax is valid for ${{ matrix.brand }}');"

      - name: Validate token structure
        run: |
          node << 'EOF'
          const fs = require('fs');
          const brand = '${{ matrix.brand }}';
          const brandFile = `brands/${brand}-tokens.json`;

          if (!fs.existsSync(brandFile)) {
            console.error(`❌ Error: Brand file ${brandFile} not found`);
            process.exit(1);
          }

          const data = JSON.parse(fs.readFileSync(brandFile, 'utf8'));

          // Check if it's an array
          if (!Array.isArray(data)) {
            console.error(`❌ Error: ${brandFile} must be an array`);
            process.exit(1);
          }

          // Check if at least one theme exists
          if (data.length === 0) {
            console.error(`❌ Error: At least one theme must exist in ${brandFile}`);
            process.exit(1);
          }

          // Validate each theme
          for (const themeObj of data) {
            const themeName = Object.keys(themeObj)[0];
            const theme = themeObj[themeName];
            
            // Check if theme has modes
            if (!theme.modes || typeof theme.modes !== 'object') {
              console.error(`❌ Error: Theme ${themeName} must have a 'modes' object`);
              process.exit(1);
            }
            
            // Check if light and dark modes exist
            if (!theme.modes.light || !theme.modes.dark) {
              console.error(`❌ Error: Theme ${themeName} must have both 'light' and 'dark' modes`);
              process.exit(1);
            }
            
            // Validate tokens in each mode
            for (const [modeName, tokens] of Object.entries(theme.modes)) {
              if (typeof tokens !== 'object') {
                console.error(`❌ Error: Theme ${themeName}, mode ${modeName} must be an object`);
                process.exit(1);
              }
              
              // Check if tokens have required properties
              for (const [tokenName, token] of Object.entries(tokens)) {
                if (!token.$type || !token.hasOwnProperty('$value')) {
                  console.error(`❌ Error: Token ${tokenName} in ${themeName}/${modeName} must have $type and $value properties`);
                  process.exit(1);
                }
              }
            }
          }

          console.log(`✅ Token structure is valid for brand: ${brand}`);
          console.log(`✅ Found ${data.length} theme(s) in ${brand}`);
          EOF

      - name: Trigger design-token-lib build
        if: success() && github.event_name == 'push'
        uses: peter-evans/repository-dispatch@v2
        with:
          token: ${{ secrets.DESIGN_TOKENS_LIB_TOKEN }}
          repository: ${{ secrets.DESIGN_TOKENS_LIB }}
          event-type: tokens-updated
          client-payload: |
            {
              "brand": "${{ matrix.brand }}",
              "ref": "${{ github.ref }}",
              "sha": "${{ github.sha }}",
              "repository": "${{ github.repository }}"
            }
